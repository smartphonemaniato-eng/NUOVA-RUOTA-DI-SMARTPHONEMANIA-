<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <title>Ruota SmartphoneMania</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(circle at top, #ffffff20, #0b1220 55%, #020617 100%),
        linear-gradient(135deg, #991b1b, #14532d);
      color: #e5e7eb;
      overflow: hidden;
    }

    body::before {
      content: "";
      position: fixed;
      inset: 0;
      pointer-events: none;
      background-image:
        radial-gradient(circle, rgba(255,255,255,0.6) 0, rgba(255,255,255,0) 55px),
        radial-gradient(circle, rgba(255,255,255,0.4) 0, rgba(255,255,255,0) 45px);
      background-size: 260px 260px, 180px 180px;
      background-position: 0 0, 80px 120px;
      opacity: 0.3;
      mix-blend-mode: screen;
      z-index: 0;
    }

    /* ===================== FX LAYER (PRO MODE) ===================== */
    #fxLayer{
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 9998;
      overflow: hidden;
    }

    .confetti{
      position:absolute;
      top:-12px;
      width:10px;
      height:14px;
      border-radius:2px;
      opacity:.95;
      transform: translate3d(0,0,0) rotate(0deg);
      filter: drop-shadow(0 0 10px rgba(250,204,21,.35));
      animation: confettiFall 1.8s linear forwards;
    }
    @keyframes confettiFall{
      0%   { transform: translate3d(var(--xStart), -20px, 0) rotate(0deg); opacity: 0; }
      10%  { opacity: 1; }
      100% { transform: translate3d(var(--xEnd), 110vh, 0) rotate(720deg); opacity: .95; }
    }

    .fx-flash{
      position:absolute;
      inset:0;
      background: radial-gradient(circle at 50% 30%, rgba(250,204,21,.42), rgba(250,204,21,0) 60%),
                  radial-gradient(circle at 50% 70%, rgba(56,189,248,.18), rgba(56,189,248,0) 55%);
      mix-blend-mode: screen;
      opacity: 0;
      animation: fxFlash 1.1s ease-out forwards;
    }
    @keyframes fxFlash{
      0%   { opacity: 0; }
      10%  { opacity: 1; }
      100% { opacity: 0; }
    }

    /* LOGIN SCREEN */
    .login-screen {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: radial-gradient(circle at top, rgba(15,23,42,0.95), #020617);
      z-index: 9999;
    }

    .login-box {
      width: 90%;
      max-width: 320px;
      padding: 16px 18px;
      border-radius: 14px;
      background: rgba(15,23,42,0.96);
      border: 1px solid rgba(148,163,184,0.8);
      box-shadow: 0 20px 50px rgba(0,0,0,0.8);
      font-size: 12px;
    }

    .login-box h2 {
      font-size: 16px;
      margin-bottom: 6px;
      text-align: center;
    }

    .login-note {
      font-size: 11px;
      color: #9ca3af;
      margin-bottom: 8px;
      text-align: center;
    }

    #loginForm {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    #loginForm label {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }

    #loginForm input {
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      padding: 4px 10px;
      font-size: 12px;
    }

    #loginForm button {
      margin-top: 6px;
      border: none;
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 12px;
      font-weight: 600;
      cursor: pointer;
      background: radial-gradient(circle at 20% 0, #22c55e,#15803d);
      color:#fefce8;
      box-shadow: 0 8px 18px rgba(22,163,74,0.6);
    }

    .login-small {
      margin-top: 6px;
      font-size: 10px;
      color: #9ca3af;
      text-align: center;
    }

    .app {
      width: 100%;
      height: 100vh;
      max-width: 900px;
      max-height: 100vh;
      padding: 4px 6px 6px;
      background:
        radial-gradient(circle at top, rgba(248,250,252,0.15), rgba(15,23,42,.96));
      box-shadow:
        0 25px 60px rgba(0,0,0,.9),
        0 0 0 1px rgba(148,163,184,.4);
      border-radius: 12px;
      position: relative;
      display: flex;
      flex-direction: column;
      z-index: 1;
      overflow: hidden;
      transition: box-shadow 0.25s ease, transform 0.25s ease;
    }

    .app.jackpot-locked {
      box-shadow:
        0 0 40px rgba(250,204,21,.9),
        0 0 80px rgba(250,250,210,.9),
        0 0 0 1px rgba(250,250,210,.9);
      transform: scale(1.01);
    }

    /* PRO MODE: shake su jackpot */
    .app.jackpot-shake{
      animation: jackpotShake .75s cubic-bezier(.2,.9,.2,1) both;
    }
    @keyframes jackpotShake{
      0%{ transform: translate3d(0,0,0) scale(1.01); }
      12%{ transform: translate3d(-6px, 3px, 0) scale(1.012); }
      24%{ transform: translate3d(7px, -4px, 0) scale(1.013); }
      36%{ transform: translate3d(-8px, -2px, 0) scale(1.013); }
      48%{ transform: translate3d(7px, 6px, 0) scale(1.012); }
      60%{ transform: translate3d(-5px, 4px, 0) scale(1.012); }
      72%{ transform: translate3d(4px, -5px, 0) scale(1.011); }
      100%{ transform: translate3d(0,0,0) scale(1.01); }
    }

    .app::before,
    .app::after {
      content: "";
      position: absolute;
      width: 160px;
      height: 160px;
      border-radius: 50%;
      border: 8px dashed rgba(22,163,74,0.9);
      filter: drop-shadow(0 0 12px rgba(34,197,94,0.8));
      opacity: 0.25;
      pointer-events: none;
      z-index: 0;
    }
    .app::before { top: -80px; left: -50px; }
    .app::after { bottom: -80px; right: -40px; }

    header {
      text-align: center;
      margin-bottom: 4px;
      position: relative;
      z-index: 2;
    }
    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 9px;
      border-radius: 999px;
      background: radial-gradient(circle at top left, rgba(248,250,252,.25), transparent),
                  linear-gradient(135deg, #b91c1c, #f97316);
      font-size: 9px;
      text-transform: uppercase;
      letter-spacing: .06em;
      margin-bottom: 3px;
    }
    .badge span { font-weight: 600; }
    h1 { font-size: 18px; margin-bottom: 1px; }
    .subtitle { font-size: 10px; }

    /* CTA ORO (lampeggiante) */
    .cta-missile{
      margin-top: 2px;
      font-size: 12px;
      font-weight: 900;
      letter-spacing: .14em;
      text-transform: uppercase;
      color: #fbbf24;
      text-shadow:
        0 0 6px rgba(251,191,36,.9),
        0 0 18px rgba(245,158,11,.75),
        0 2px 0 rgba(120,53,15,.9);
      animation: goldPulse 1s ease-in-out infinite alternate;
    }
    @keyframes goldPulse{
      0%{ filter: brightness(1); transform: translateY(0); opacity:.92; }
      100%{ filter: brightness(1.35); transform: translateY(-1px); opacity:1; }
    }

    .content {
      flex: 1;
      display: grid;
      grid-template-columns: 180px 1fr 180px;
      gap: 4px;
      position: relative;
      z-index: 2;
    }

    @media (max-width: 720px) {
      .content { grid-template-columns: 1fr; }
    }

    .left, .right {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .left { justify-content: center; }

    .wheel-wrapper {
      position: relative;
      width: min(280px, 62vw);
      height: min(280px, 62vw);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    @media (max-height: 700px) {
      .wheel-wrapper {
        width: min(250px, 58vw);
        height: min(250px, 58vw);
      }
      h1 { font-size: 17px; }
      .subtitle { font-size: 9px; }
    }

    .wheel-ring {
      position: absolute;
      inset: 0;
      border-radius: 999px;
      border: 10px solid #020617;
      box-shadow:
        0 0 0 2px rgba(248,250,252,.2),
        0 0 28px rgba(56,189,248,.9);
      z-index: 1;
    }

    .text-ring { position: absolute; inset: -2px; border-radius: 50%; pointer-events: none; z-index: 6; }

    .led-ring {
      position: absolute;
      inset: -6px;
      border-radius: 999px;
      pointer-events: none;
      z-index: 3;
      animation: casinoRotate 2.5s linear infinite;
    }

    @keyframes casinoRotate {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    .led-dot {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 9px;
      height: 9px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, #fef9c3, #b45309);
      box-shadow:
        0 0 4px rgba(250,204,21,.9),
        0 0 10px rgba(250,204,21,.9),
        0 0 16px rgba(248,250,252,.8);
      opacity: 0.5;
      transform-origin: 0 0;
      animation: ledPulse 0.9s ease-in-out infinite alternate;
    }
    @keyframes ledPulse {
      0% { opacity: .2; transform: scale(.85); }
      100% { opacity: 1; transform: scale(1.2); }
    }

    .light-sweep-outer {
      position: absolute;
      inset: -6px;
      border-radius: 999px;
      background: conic-gradient(
        from 0deg,
        rgba(250,250,210,0) 0deg,
        rgba(250,250,210,0) 300deg,
        rgba(250,250,210,0.95) 320deg,
        rgba(250,250,210,0.4) 340deg,
        rgba(250,250,210,0) 360deg
      );
      mix-blend-mode: screen;
      opacity: 0.8;
      pointer-events: none;
      animation: sweepOuter 2.6s linear infinite;
      z-index: 2;
    }
    @keyframes sweepOuter {
      from { transform: rotate(0deg); }
      to   { transform: rotate(360deg); }
    }

    .wheel {
      position: relative;
      width: 88%;
      height: 88%;
      border-radius: 999px;
      background: conic-gradient(
          from -90deg,
          #f97373 0deg 45deg,
          #facc15 45deg 90deg,
          #4ade80 90deg 135deg,
          #38bdf8 135deg 180deg,
          #e879f9 180deg 225deg,
          #9ca3af 225deg 270deg,
          #22c55e 270deg 315deg,
          #0f172a 315deg 360deg
      );
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      box-shadow:
        0 16px 32px rgba(0,0,0,.9),
        inset 0 0 18px rgba(15,23,42,.95);
      transition: transform 4.8s cubic-bezier(.11,.9,.25,1);
      z-index: 5;
    }

    /* PRO MODE: glow pulse sulla ruota quando jackpot */
    .wheel.jackpot-glow{
      animation: wheelGlow .75s ease-in-out 1;
    }
    @keyframes wheelGlow{
      0%{ box-shadow: 0 16px 32px rgba(0,0,0,.9), inset 0 0 18px rgba(15,23,42,.95); }
      35%{
        box-shadow:
          0 0 0 2px rgba(250,204,21,.75),
          0 0 40px rgba(250,204,21,.75),
          0 0 70px rgba(56,189,248,.55);
      }
      100%{ box-shadow: 0 16px 32px rgba(0,0,0,.9), inset 0 0 18px rgba(15,23,42,.95); }
    }

    .garland-ring {
      position: absolute;
      inset: -16px;
      border-radius: 999px;
      border: 12px solid transparent;
      background: conic-gradient(
        #166534, #065f46, #16a34a, #b91c1c,
        #166534, #16a34a, #b91c1c, #16a34a,
        #166534, #b91c1c, #166534, #16a34a,
        #b91c1c, #16a34a, #166534, #b91c1c,
        #166534, #16a34a, #b91c1c, #16a34a,
        #166534, #b91c1c, #16a34a, #166534,
        #b91c1c, #16a34a, #166534, #b91c1c,
        #16a34a, #166534, #b91c1c, #16a34a,
        #166534, #b91c1c, #16a34a, #166534
      );
      opacity: 0.9;
      box-shadow: 0 0 18px rgba(22,163,74,0.7), 0 0 24px rgba(220,38,38,0.6);
      z-index: 0;
    }

    .wheel-snow {
      position: absolute;
      inset: 4%;
      border-radius: 50%;
      pointer-events: none;
      z-index: 4;

      /* Falling gold coins (small tokens) */
      background-image:
        radial-gradient(circle at 30% 30%, rgba(255,255,255,.95) 0 1.2px, rgba(255,255,255,0) 2.6px),
        radial-gradient(circle, rgba(250,204,21,.95) 0 3.1px, rgba(250,204,21,0) 4.2px),
        radial-gradient(circle at 35% 35%, rgba(255,255,255,.85) 0 1px, rgba(255,255,255,0) 2.2px),

        radial-gradient(circle at 30% 30%, rgba(255,255,255,.9) 0 1.1px, rgba(255,255,255,0) 2.4px),
        radial-gradient(circle, rgba(245,158,11,.92) 0 2.7px, rgba(245,158,11,0) 3.8px),
        radial-gradient(circle at 35% 35%, rgba(255,255,255,.8) 0 0.9px, rgba(255,255,255,0) 2px),

        radial-gradient(circle at 30% 30%, rgba(255,255,255,.9) 0 1.0px, rgba(255,255,255,0) 2.3px),
        radial-gradient(circle, rgba(234,179,8,.9) 0 2.3px, rgba(234,179,8,0) 3.4px),
        radial-gradient(circle at 35% 35%, rgba(255,255,255,.75) 0 0.85px, rgba(255,255,255,0) 1.9px);

      /* Each triplet above = one "coin" sprite (highlight + gold body + highlight) */
      background-size:
        70px 70px, 70px 70px, 70px 70px,
        92px 92px, 92px 92px, 92px 92px,
        120px 120px, 120px 120px, 120px 120px;

      background-position:
        0 -90px, 0 -90px, 0 -90px,
        40px -130px, 40px -130px, 40px -130px,
        -30px -110px, -30px -110px, -30px -110px;

      animation: snowFall 6.2s linear infinite;
      mix-blend-mode: screen;
      opacity: 0.9;
      filter: drop-shadow(0 0 6px rgba(250,204,21,.55));
    }
    @keyframes snowFall {
      0% {
        background-position:
          0 -90px, 0 -90px, 0 -90px,
          40px -130px, 40px -130px, 40px -130px,
          -30px -110px, -30px -110px, -30px -110px;
      }
      100% {
        background-position:
          0 160px, 0 160px, 0 160px,
          40px 210px, 40px 210px, 40px 210px,
          -30px 190px, -30px 190px, -30px 190px;
      }
    }

100% { background-position: 0 120px, 40px 140px, -30px 110px; }
    }

    .wheel-center {
      position: absolute;
      inset: 36%;
      border-radius: 999px;
      background: #020617;
      box-shadow:
        0 0 0 3px rgba(248,250,252,.35),
        0 0 20px rgba(56,189,248,.9);
      z-index: 6;
      overflow: hidden;
    }

    .wheel-logo {
      position: absolute;
      width: 38%;
      height: 38%;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border-radius: 999px;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      background: #020617;
      z-index: 7;
    }
    .wheel-logo img { width: 100%; height: 100%; object-fit: contain; }

    .pointer {
      position: absolute;
      top: -6px;
      left: 50%;
      transform: translateX(-50%);
      width: 0;
      height: 0;
      border-left: 12px solid transparent;
      border-right: 12px solid transparent;
      border-bottom: 22px solid #facc15;
      filter: drop-shadow(0 4px 6px rgba(0,0,0,.8));
      z-index: 10;
    }

    .pointer-base {
      position: absolute;
      top: 14px;
      left: 50%;
      transform: translateX(-50%);
      width: 32px;
      height: 14px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fef9c3,#b45309);
      box-shadow:
        0 0 0 2px rgba(248,250,252,.6),
        0 0 10px rgba(250,204,21,.7);
      z-index: 9;
    }

    .missile-left{ left:-20%; bottom:-14px; }
      .missile-right{ right:-20%; top:-14px; }
    }

    .controls {
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 3px;
    }
    .btn {
      border: none;
      border-radius: 999px;
      padding: 7px 16px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: transform .12s ease, box-shadow .12s ease, opacity .2s ease;
    }
    .btn-primary {
      background: radial-gradient(circle at 20% 0, #f97316,#dc2626);
      color:#fefce8;
      box-shadow:
        0 10px 20px rgba(220,38,38,.6),
        0 0 0 1px rgba(248,250,252,.2);
    }
    .btn-primary:active {
      transform: translateY(1px) scale(.98);
      box-shadow:
        0 6px 12px rgba(220,38,38,.5),
        0 0 0 1px rgba(248,250,252,.2);
    }
    .btn-secondary {
      background: rgba(15,23,42,.85);
      color:#e5e7eb;
      border:1px solid rgba(148,163,184,.7);
      font-size:11px;
      padding-inline:12px;
    }
    .btn-small { font-size: 11px; padding: 5px 12px; }

    .music-toggle { font-size: 11px; cursor: pointer; color: #bbf7d0; }
    .info-row { display:flex; gap:6px; justify-content:center; font-size:11px; color:#9ca3af; flex-wrap: wrap; }
    .chip {
      padding:3px 8px;
      border-radius:999px;
      background:rgba(15,23,42,.8);
      border:1px solid rgba(148,163,184,.5);
    }

    .legend, .nick, .leaderboard {
      width:100%;
      border-radius:12px;
      padding:7px 8px;
      background:rgba(15,23,42,.9);
      border:1px solid rgba(55,65,81,.85);
      font-size:11px;
      margin-bottom:5px;
      position: relative;
      z-index: 2;
    }
    .legend-title, .nick-title, .leaderboard-title {
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:600;
      margin-bottom:3px;
    }
    .legend-list { margin-left:14px; color:#d1d5db; }

    .legend-combined { padding:6px 7px; }
    .legend-cols { display:flex; gap:6px; }
    .legend-col { flex:1; min-width:0; }

    .result {
      width:100%;
      border-radius:10px;
      padding:4px 6px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(55,65,81,.85);
      font-size:11px;
      margin-bottom:4px;
    }

    .result-title {
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:600;
      margin-bottom:3px;
    }

    .result-main { font-size:13px; font-weight:700; margin-bottom:3px; }
    .result-main.jackpot{
      color:#facc15;
      text-shadow:0 0 6px rgba(250,204,21,.9),0 0 18px rgba(250,204,21,.9);
      animation: jackpotTextBlink 0.4s ease-in-out infinite alternate;
    }
    @keyframes jackpotTextBlink {
      0% { transform: scale(1); }
      100% { transform: scale(1.05); }
    }
    .result-main.win{color:#4ade80;}
    .result-main.lose{color:#f97373;}
    .result-sub span{font-weight:600;}

    .stats-inline {
      width:100%;
      border-radius:10px;
      padding:4px 6px;
      background:rgba(15,23,42,0.95);
      border:1px solid rgba(55,65,81,.85);
      font-size:11px;
      margin-bottom:0;
    }
    .stats-title {
      display:flex;
      align-items:center;
      gap:6px;
      font-weight:600;
      margin-bottom:2px;
    }
    .stats-row{
      display:flex;
      justify-content:space-between;
      margin-bottom:1px;
    }

    .footer-note {
      font-size:9px;
      color:#9ca3af;
      text-align:center;
      margin-top: 2px;
    }

    .hidden{display:none;}
    .xmas-msg {
      margin-top: 4px;
      font-size: 11px;
      text-align: center;
      color: #facc15;
      text-shadow: 0 0 6px rgba(250,204,21,0.7);
      font-weight: 600;
    }

    .prize-overlay {
      position:fixed;
      inset:0;
      display:flex;
      align-items:flex-start;
      justify-content:center;
      pointer-events:none;
      z-index:30;
      padding-top: 40px;
      animation:prizeFade 2.6s ease-out forwards;
    }
    @keyframes prizeFade {
      0%{opacity:0;}10%{opacity:1;}80%{opacity:1;}100%{opacity:0;}
    }
    .prize-overlay-fixed {
      animation: none;
    }
    .prize-banner{
      padding:16px 24px;
      border-radius:20px;
      background:radial-gradient(circle at 20% 0,#f9fafb,#e5e7eb);
      box-shadow:
        0 0 0 3px rgba(248,250,252,.9),
        0 24px 60px rgba(0,0,0,.9);
      text-align:center;
      border:2px solid rgba(148,163,184,.9);
      max-width:80%;
    }
    .prize-title{
      font-size:20px;
      font-weight:900;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:#111827;
      margin-bottom:4px;
    }
    .prize-amount{
      font-size:24px;
      font-weight:900;
      color:#16a34a;
      text-shadow:0 0 6px rgba(34,197,94,.6);
    }
    .prize-sub{
      font-size:12px;
      margin-top:4px;
      color:#374151;
    }

    .prize-banner.jackpot{
      background:radial-gradient(circle at 20% 0,#fef9c3,#b45309);
      border-color:#fef08a;
    }
    .prize-title.jackpot{
      font-size:26px;
      color:#7c2d12;
      letter-spacing:.25em;
      animation:jackpotBlink .4s ease-in-out infinite alternate;
    }
    .prize-amount.jackpot{
      font-size:34px;
      color:#b91c1c;
      text-shadow:0 0 6px rgba(248,113,113,.9),0 0 18px rgba(239,68,68,.9);
      animation:jackpotBlink .4s ease-in-out infinite alternate;
    }
    @keyframes jackpotBlink{
      0%{transform:scale(1);opacity:.85;}
      100%{transform:scale(1.2);opacity:1;}
    }

    .nick { margin-bottom:4px; }
    .nick-input-row {
      display: flex;
      gap: 6px;
      margin-top: 2px;
      margin-bottom: 3px;
    }
    .nick-input {
      flex: 1;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.7);
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
      padding: 4px 10px;
      font-size: 11px;
      outline: none;
    }
    .nick-input::placeholder { color: #6b7280; }
    .nick-current { font-size: 10px; color: #9ca3af; }

    .leaderboard-list {
      margin-left: 16px;
      margin-top: 3px;
      color: #d1d5db;
      max-height: 120px;
      overflow: hidden;
    }
    .leaderboard-list li { margin-bottom: 2px; }

    .multi-input {
      width: 52px;
      margin-left: 4px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.7);
      background: rgba(15,23,42,.95);
      color: #e5e7eb;
      padding: 2px 6px;
      font-size: 11px;
      text-align: center;
    }

    .multi-status {
      position: absolute;
      top: 6px;
      right: 8px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,.95);
      border: 1px solid rgba(250,204,21,.8);
      font-size: 11px;
      color: #facc15;
      text-shadow: 0 0 4px rgba(250,204,21,.7);
      box-shadow: 0 8px 20px rgba(0,0,0,.6);
      z-index: 5;
    }
  
    /* ===================== JACKPOT BOTTOM BANNER ===================== */
    .jackpot-bottom{
      position: fixed;
      bottom: -140px;
      left: 50%;
      transform: translateX(-50%);
      padding: 16px 34px;
      border-radius: 999px;
      background: radial-gradient(circle at top,#fde68a,#b45309);
      color:#7c2d12;
      font-size:20px;
      font-weight:900;
      letter-spacing:.22em;
      text-transform: uppercase;
      box-shadow:
        0 0 30px rgba(250,204,21,.95),
        0 0 90px rgba(250,204,21,.55);
      z-index: 10000;
      opacity: 0;
      pointer-events: none;
    }
    .jackpot-bottom.show{
      animation: jackpotRise 1.2s ease-out forwards, jackpotGlow 0.35s ease-in-out infinite alternate;
    }
    @keyframes jackpotRise{
      0%{ bottom:-140px; opacity:0; }
      35%{ opacity:1; }
      100%{ bottom:56px; opacity:1; }
    }
    @keyframes jackpotGlow{
      from{ filter: brightness(1); transform: translateX(-50%) scale(1); }
      to  { filter: brightness(1.25); transform: translateX(-50%) scale(1.03); }
    }

    /* ===================== FIREWORKS (BOTTOM) ===================== */
    #fireworkLayer{
      position: fixed;
      inset: 0;
      pointer-events:none;
      z-index: 9997;
      overflow:hidden;
    }
    .fw-rocket{
      position:absolute;
      bottom:-30px;
      width:8px;
      height:18px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, rgba(248,250,252,1), rgba(56,189,248,.9), rgba(167,139,250,.8));
      box-shadow: 0 0 10px rgba(56,189,248,.9), 0 0 18px rgba(167,139,250,.75);
      animation: fwLaunch 0.9s ease-out forwards;
      opacity: .95;
    }
    @keyframes fwLaunch{
      from{ transform: translateY(0) scale(1); opacity:.95; }
      to  { transform: translateY(var(--yEnd)) scale(1.15); opacity:0; }
    }
    .fw-spark{
      position:absolute;
      width:6px;
      height:6px;
      border-radius: 50%;
      background: radial-gradient(circle at 30% 20%, rgba(254,252,232,1), rgba(250,204,21,.95), rgba(239,68,68,.75));
      box-shadow: 0 0 10px rgba(250,204,21,.9), 0 0 18px rgba(239,68,68,.7);
      animation: fwBurst 1.15s ease-out forwards;
      opacity: .95;
    }
    @keyframes fwBurst{
      0%{ transform: translate3d(0,0,0) scale(1); opacity: 1; }
      100%{ transform: translate3d(var(--dx), var(--dy), 0) scale(0.25); opacity: 0; }
    }

    /* ===================== JACKPOT UI LOCK ===================== */
    .btn.locked{
      opacity: .55;
      pointer-events: none;
      filter: grayscale(.2);
    }

  
    /* ===================== UNIVERSE JACKPOT VIDEO (BOTTOM) ===================== */
    .jackpot-universe{
      position: fixed;
      bottom: -340px;
      left: 50%;
      transform: translateX(-50%);
      width: min(520px, 96vw);
      z-index: 10001;
      opacity: 0;
      pointer-events: none;
      will-change: transform, opacity, bottom;
    }
    .jackpot-universe.show{
      animation: universeRise 0.85s cubic-bezier(.12,.9,.18,1) forwards;
    }
    .jackpot-universe video{
      width: 100%;
      display:block;
      border-radius: 20px;
      box-shadow:
        0 0 40px rgba(250,204,21,.9),
        0 0 110px rgba(56,189,248,.55);
      border: 1px solid rgba(250,204,21,.45);
      background: rgba(2,6,23,.65);
    }
    @keyframes universeRise{
      0%{ bottom:-340px; opacity:0; }
      100%{ bottom:18px; opacity:1; }
    }

  
    /* ===================== LAYOUT: LEFT/RIGHT CONTROL COLUMNS ===================== */
    .left-controls, .right-controls{
      width:100%;
      border-radius:12px;
      padding:8px 8px;
      background:rgba(15,23,42,.85);
      border:1px solid rgba(148,163,184,.55);
      display:flex;
      flex-direction:column;
      gap:8px;
      align-self: start;
    }
    .left-controls .btn,
    .right-controls .chip{
      width:100%;
      justify-content:center;
    }
    .right-controls .chip{
      display:flex;
      flex-direction:column;
      gap:6px;
      align-items:center;
      text-align:center;
      font-size:11px;
      padding:8px 10px;
    }
    .right-controls .chip select,
    .right-controls .chip input{
      width:100%;
      max-width:120px;
    }

    /* ===================== SIDE GIFTS (TIKTOK UNIVERSE) ===================== */
    .side-gifts{
      position:absolute;
      inset:0;
      pointer-events:none;
      z-index: 4;
    }
    .gift-left, .gift-right{
      position:absolute;
      width:140px;
      height:140px;
      opacity:1;
      filter:
        drop-shadow(0 0 18px rgba(250,204,21,.95))
        drop-shadow(0 0 26px rgba(56,189,248,.75))
        drop-shadow(0 0 34px rgba(167,139,250,.75));
      animation: giftPulse 1.15s ease-in-out infinite alternate;
    }
    .gift-left{ left: 6px; top: 46%; transform: translateY(-50%) rotate(-6deg); --rot:-6deg; }
    .gift-right{ right: 6px; top: 46%; transform: translateY(-50%) rotate(6deg); --rot:6deg; }
    .gift-left img, .gift-right img{ width:100%; height:100%; object-fit:contain; display:block; }

    @keyframes giftPulse{
      0%{ transform: translateY(-50%) scale(1) rotate(var(--rot)); filter: brightness(1); }
      100%{ transform: translateY(-50%) scale(1.08) rotate(var(--rot)); filter: brightness(1.25); }
    }

    .gift-spark{
      position:absolute;
      inset:-10px;
      border-radius: 22px;
      background: conic-gradient(from 0deg,
        rgba(250,204,21,0) 0deg,
        rgba(250,204,21,.9) 45deg,
        rgba(56,189,248,0) 90deg,
        rgba(167,139,250,.9) 135deg,
        rgba(250,204,21,0) 180deg,
        rgba(56,189,248,.9) 225deg,
        rgba(250,204,21,0) 270deg,
        rgba(167,139,250,.9) 315deg,
        rgba(250,204,21,0) 360deg
      );
      opacity:.55;
      mix-blend-mode: screen;
      filter: blur(0.5px);
      animation: sparkSpin 2.2s linear infinite;
    }
    @keyframes sparkSpin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }

    /* ===================== LEADERBOARD DROPDOWN ===================== */
    .lb-top3{
      margin-left:16px;
      margin-top:3px;
      color:#d1d5db;
    }
    .lb-top3 li{ margin-bottom: 2px; }
    .lb-toggle{
      margin-top: 8px;
      width:100%;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,.7);
      background: rgba(15,23,42,.9);
      color:#e5e7eb;
      padding: 6px 10px;
      font-size: 11px;
      font-weight: 700;
      cursor:pointer;
    }
    .lb-all{
      margin-top: 8px;
      border-radius: 12px;
      border: 1px solid rgba(55,65,81,.85);
      background: rgba(15,23,42,.85);
      padding: 8px 10px;
      max-height: 210px;
      overflow:auto;
    }
    .lb-all ol{
      margin-left: 16px;
      color:#d1d5db;
    }

    @media (max-width: 720px){
      .content{ grid-template-columns: 1fr; }
      .left-controls, .right-controls{ order: 2; }
      .left{ order: 1; }
      .right{ order: 3; }
      .gift-left, .gift-right{ width: 120px; height:120px; top: 54%; }
    }
  
    /* ===================== UNIVERSE WINGS (AL POSTO DEI MISSILI) ===================== */
    .universe-wing{
      position:absolute;
      top: 18%;
      width: 132px;
      height: 132px;
      transform: translateY(-50%);
      pointer-events:none;
      z-index: 8;
      filter:
        drop-shadow(0 0 18px rgba(250,204,21,.95))
        drop-shadow(0 0 26px rgba(56,189,248,.75))
        drop-shadow(0 0 34px rgba(167,139,250,.75));
      animation: wingPulse 1.15s ease-in-out infinite alternate;
    }
    .universe-wing.left{ left:-20%; }
    .universe-wing.right{ right:-20%; }
    .universe-wing img{ width:100%; height:100%; object-fit:contain; display:block; }

    .wing-spark{
      position:absolute;
      inset:-10px;
      border-radius: 22px;
      background: conic-gradient(from 0deg,
        rgba(250,204,21,0) 0deg,
        rgba(250,204,21,.95) 45deg,
        rgba(56,189,248,0) 90deg,
        rgba(167,139,250,.95) 135deg,
        rgba(250,204,21,0) 180deg,
        rgba(56,189,248,.95) 225deg,
        rgba(250,204,21,0) 270deg,
        rgba(167,139,250,.95) 315deg,
        rgba(250,204,21,0) 360deg
      );
      opacity:.55;
      mix-blend-mode: screen;
      filter: blur(0.5px);
      animation: wingSparkSpin 2.2s linear infinite;
    }
    @keyframes wingSparkSpin{
      from{ transform: rotate(0deg); }
      to{ transform: rotate(360deg); }
    }
    @keyframes wingPulse{
      0%{ transform: translateY(-50%) scale(1); filter: brightness(1); }
      100%{ transform: translateY(-50%) scale(1.08); filter: brightness(1.25); }
    }

    /* ===================== COMPACT FIT (tutto visibile in browser) ===================== */
    .app{ max-width: 860px; padding: 4px 6px 6px; }
    header{ margin-bottom: 3px; }
    h1{ font-size: 16px; }
    .subtitle{ font-size: 9px; }
    .cta-missile{ font-size: 11px; margin-top: 1px; }
    .wheel-wrapper{ width: min(260px, 58vw); height: min(260px, 58vw); }
    @media (max-height: 700px){
      .wheel-wrapper{ width: min(235px, 54vw); height: min(235px, 54vw); }
    }

    .legend, .nick, .leaderboard{ padding: 6px 7px; margin-bottom: 4px; font-size: 10.5px; }
    .result, .stats-inline{ padding: 4px 6px; margin-bottom: 3px; font-size: 10.5px; }
    .result-main{ font-size: 12px; margin-bottom: 2px; }
    .footer-note{ font-size: 8.5px; }
    .lb-all{ max-height: 170px; }

    @media (max-width: 720px){
      .universe-wing{ width: 112px; height:112px; }
      .universe-wing.left{ left:-20%; }
      .universe-wing.right{ right:-20%; }
      .wheel-wrapper{ width: min(250px, 74vw); height: min(250px, 74vw); }
    }
  
    /* ===================== COMPACT EXTRA FIELDS ===================== */
    .multi-input{
      padding: 6px 8px;
      font-size: 11px;
      border-radius: 10px;
    }
    #spinCostSelector, #multiSpinsInput{
      width: 100% !important;
      max-width: 120px !important;
    }
    .info-row{
      gap: 6px !important;
      margin-bottom: 3px !important;
    }
    .chip{
      padding: 6px 7px !important;
      font-size: 10.5px !important;
    }
    .wheel-wrapper{ width: min(240px, 56vw) !important; height: min(240px, 56vw) !important; }
    .legend, .nick, .leaderboard{ margin-bottom: 3px !important; }
    .lb-all{ max-height: 150px !important; }
    @media (max-height: 700px){
      .wheel-wrapper{ width: min(225px, 52vw) !important; height: min(225px, 52vw) !important; }
      .chip{ font-size: 10px !important; }
      #spinCostSelector, #multiSpinsInput{ max-width: 110px !important; }
    }
  
    /* ===================== SIMPLE PAGE SCROLL ===================== */
    html, body{
      overflow-y: auto;
      height: auto;
    }
  
    /* ===================== HIDE INTERFERING UNIVERSE-WING ===================== */
    .universe-wing{ display:none !important; }
  
    /* ===================== UNIVERSE WING HIDDEN FINAL ===================== */
    .universe-wing{
      opacity: 0 !important;
      pointer-events: none !important;
    }
  
/* ===================== EXTRA SPARKLE + BRIGHTER ROTATION ===================== */
.wheel-wrapper{ position: relative; }

/* Bright rotating sparkle ring "sotto" (behind the wheel) */
.wheel-spark-ring{
  position:absolute;
  inset:-18px;
  border-radius:999px;
  z-index: 1;
  pointer-events:none;
  opacity: .95;
  mix-blend-mode: screen;
  background:
    conic-gradient(from 0deg,
      rgba(255,255,255,0) 0deg,
      rgba(250,204,21,.95) 25deg,
      rgba(56,189,248,0) 70deg,
      rgba(167,139,250,.85) 110deg,
      rgba(255,255,255,0) 160deg,
      rgba(56,189,248,.9) 210deg,
      rgba(255,255,255,0) 260deg,
      rgba(250,204,21,.9) 300deg,
      rgba(255,255,255,0) 360deg
    );
  filter: blur(0.6px) brightness(1.35);
  animation: sparkRingSpin 1.8s linear infinite;
}

/* Keep wheel itself above ring */
.wheel, canvas, .wheel-center, .wheel-pointer, .light-sweep, .light-sweep-outer{
  position: relative;
  z-index: 3;
}

@keyframes sparkRingSpin{
  from{ transform: rotate(0deg); }
  to{ transform: rotate(360deg); }
}

/* Boost outer LED dots (if present) */
.led-ring, .led-dots, .led-circle{
  filter: brightness(1.35) drop-shadow(0 0 12px rgba(250,204,21,.85)) drop-shadow(0 0 18px rgba(56,189,248,.55));
}

/* If individual led dot elements exist, make them punchier */
.led-dot{
  opacity: .95;
  filter: brightness(1.4);
}

</style>
</head>
<body>

  <!-- FX LAYER -->
  <div id="fxLayer"></div>

  <!-- JACKPOT BOTTOM + VEGAS FX -->
  <div id="jackpotBottom" class="jackpot-bottom hidden">üí• JACKPOT LIVE üí•</div>
  <div id="fireworkLayer" aria-hidden="true"></div>

  <!-- UNIVERSE JACKPOT VIDEO + MUSIC (BOTTOM) -->
  <div id="jackpotUniverse" class="jackpot-universe hidden" aria-hidden="true">
    <video id="universeVideo" src="tiktokuniverse.mp4" playsinline preload="auto"></video>
  </div>
  <audio id="universeAudio" src="tiktok_universo.mp3" preload="auto"></audio>



  <!-- AUDIO -->
  <audio id="bgMusic" src="musica_bg.mp3" loop autoplay muted></audio>
  <audio id="spinSound" src="spin.mp3" preload="auto"></audio>
  <audio id="winSmallSound" src="win_small.mp3" preload="auto"></audio>
  <audio id="winMediumSound" src="win_medium.mp3" preload="auto"></audio>
  <audio id="jackpotSound" src="jackpot.mp3" preload="auto"></audio>
  <audio id="loseSound" src="lose.mp3" preload="auto"></audio>

  <div id="prize-overlay" class="hidden"></div>

  <!-- LOGIN -->
  <div id="loginScreen" class="login-screen">
    <div class="login-box">
      <h2>Accesso Presentatore</h2>
      <p class="login-note">
        Inserisci le credenziali per avviare la ruota di SmartphoneMania.
      </p>
      <form id="loginForm">
        <label>
          Username
          <input type="text" id="loginUser" autocomplete="off" />
        </label>
        <label>
          Password
          <input type="password" id="loginPass" />
        </label>
        <button type="submit">Entra</button>
      </form>
      <p class="login-small">
        Accesso riservato allo staff ¬∑ Ruota non concepita per gioco d‚Äôazzardo.
      </p>
    </div>
  </div>

  <!-- APP RUOTA -->
  <div class="app" id="appRoot" style="display:none;">
    <header>
      <div class="badge"><span>SMARTPHONEMANIA</span> ¬∑ Ruota Jackpot</div>
      <h1>SMARTPHONEMANIA WHEEL</h1>
      <div class="cta-missile">SALI SUL MISSILE !!!</div>
      <p class="subtitle">Gioco interno per le live ¬∑ Jackpot 45.000 monete</p>
    </header>
<div id="multiStatus" class="multi-status hidden">Giro 1 di 1</div>

    <div class="content">

      <div class="left-controls">
        <button class="btn btn-primary" id="spinBtn">üé° Gira la ruota</button>

<div class="info-row" style="margin-top:10px; display:flex; gap:8px; justify-content:center;">
  <div class="chip compact">
    üí∞ Monete per giro
    <select id="spinCostSelector" class="multi-input">
      <option value="100">100</option>
      <option value="250">250</option>
      <option value="500">500</option>
      <option value="1000">1000</option>
      <option value="2500">2500</option>
      <option value="5000">5000</option>
    </select>
  </div>

  <div class="chip compact">
    üî¢ Giri multipli
    <input
      type="number"
      id="multiSpinsInput"
      min="1"
      max="100"
      value="1"
      class="multi-input"
    />
  </div>
</div>

        <button class="btn btn-secondary" id="resetBtn">üîÑ Azzera sessione</button>
        <div class="music-toggle" id="musicToggle">üîä Musica di sottofondo: OFF (tocca per ON)</div>
      </div>
      <div class="left">
        <div class="wheel-wrapper">
          <div class="wheel-ring"></div>
          <div class="garland-ring"></div>
          <div id="textRing" class="text-ring"></div>
          <div id="ledRing" class="led-ring"></div>
          <div class="light-sweep-outer"></div>
          <div class="wheel-spark-ring" aria-hidden="true"></div>


          <div class="wheel" id="wheel">
            <div class="wheel-center"></div>
            <div class="wheel-logo">
              <img src="logo_smartphonemania.png" alt="Smartphone Mania Agency Logo" />
            </div>
          </div>

          <div class="wheel-snow"></div>
          <div class="pointer"></div>
          <div class="pointer-base"></div>
          <!-- TIKTOK UNIVERSE WINGS (SCINTILLANTI) -->

          </div>

          </div>
</div>

        <div class="info-row">
            </div>

          <div class="info-row">
            </div>

      <div class="right">

        <section class="legend" style="margin-bottom:5px; text-align:center; border-color: rgba(220,38,38,0.7); background:rgba(127,29,29,0.4);">
          <div class="legend-title" style="justify-content:center; color:#fecaca;">
            <span>‚ùå</span><span style="font-size:14px;">NO GAMBLING</span>
          </div>
          <p style="font-size:11px; color:#fee2e2; text-align:center; line-height:1.3; margin-top:2px;">
            Questa ruota non √® un gioco d‚Äôazzardo.<br>
            √à un gioco interno creato solo per ringraziare e gratificare i sostenitori che supportano le mie live.
          </p>
        </section>

        <section class="nick">
          <div class="nick-title"><span>üë§</span>Nick giocatore</div>
          <div class="nick-input-row">
            <input
              type="text"
              id="nickInput"
              class="nick-input"
              placeholder="Inserisci il tuo Nick (es. Benito, Rachele...)"
            />
            <button class="btn btn-secondary btn-small" id="saveNickBtn">Salva Nick</button>
          </div>
          <div class="nick-current" id="currentNick">Nessun Nick selezionato.</div>
        </section>

        <section class="legend legend-combined">
          <div class="legend-cols">
            <div class="legend-col">
              <section class="result" id="resultBox">
                <div class="result-title"><span>üéÅ</span>Ultimo risultato</div>
                <p>Nessun giro ancora effettuato. Premi "Gira la ruota" per iniziare.</p>
              </section>

              <section class="stats-inline">
                <div class="stats-title"><span>üìä</span>Statistiche</div>
                <div class="stats-row"><span>Giri BASE totali (da 100)</span><span id="statSpins">0</span></div>
                <div class="stats-row"><span>Premi totali erogati</span><span id="statPrizes">0</span></div>
              </section>
            </div>

            <div class="legend-col">
              <div class="legend-title"><span>üìú</span>Legenda premi (per 1 giro da 100)</div>
              <ul class="legend-list">
                <li>‚ùå Nessun premio</li>
                <li>üéÅ 100 monete</li>
                <li>üéÅ 250 monete</li>
                <li>üéÅ 500 monete</li>
                <li>üéÅ 1.000 monete</li>
                <li>üéÅ 2.500 monete</li>
                <li>üí• JACKPOT 45.000 monete</li>
              </ul>
              <p class="xmas-msg">üçÄ Buona fortuna da SmartphoneMania Agency üçÄ</p>
            </div>
          </div>
        </section>

        
        
        <section class="leaderboard">
          <div class="leaderboard-title"><span>üèÜ</span>Classifica benefattori</div>

          <ol class="lb-top3" id="leaderboardTop3">
            <li>Nessun benefattore registrato per ora.</li>
          </ol>

          <div style="display:flex; gap:6px; align-items:center; margin-top:6px; flex-wrap:wrap;">
            <button class="lb-toggle" id="lbToggleBtn" style="flex:1;">üìú Vedi tutti</button>
            <select id="donorSelect" class="multi-input" style="width:100%; max-width:260px; text-align:left;">
              <option value="">Seleziona un donatore‚Ä¶</option>
            </select>
          </div>

          <div class="lb-all hidden" id="leaderboardAllWrap">
            <ol id="leaderboardAll"></ol>
          </div>
        </section>



        <p class="footer-note">
          Un giro da 5000 monete equivale a 50 giri BASE da 100, con la stessa logica di payout e premi proporzionati.
        </p>
      </div>
    </div>
  </div>

<script>
/* ===================== PRO MODE FX ===================== */
const fxLayer = document.getElementById("fxLayer");

function fxFlash(){
  if(!fxLayer) return;
  const flash = document.createElement("div");
  flash.className = "fx-flash";
  fxLayer.appendChild(flash);
  setTimeout(()=>flash.remove(), 1200);
}

function spawnConfettiBurst(count=70){
  if(!fxLayer) return;
  const vw = window.innerWidth || 360;
  for(let i=0;i<count;i++){
    const c = document.createElement("div");
    c.className = "confetti";
    // colori confetti (oro / rosso / verde / blu)
    const palette = [
      "linear-gradient(180deg, rgba(250,204,21,1), rgba(180,83,9,1))",
      "linear-gradient(180deg, rgba(239,68,68,1), rgba(127,29,29,1))",
      "linear-gradient(180deg, rgba(34,197,94,1), rgba(22,101,52,1))",
      "linear-gradient(180deg, rgba(56,189,248,1), rgba(30,64,175,1))",
      "linear-gradient(180deg, rgba(167,139,250,1), rgba(88,28,135,1))",
    ];
    c.style.background = palette[(Math.random()*palette.length)|0];

    const x0 = Math.floor(Math.random()*vw);
    const drift = (Math.random() < .5 ? -1 : 1) * (50 + Math.random()*260);
    c.style.left = x0 + "px";
    c.style.setProperty("--xStart", x0 + "px");
    c.style.setProperty("--xEnd", (x0 + drift) + "px");
    c.style.width = (7 + Math.random()*10) + "px";
    c.style.height = (10 + Math.random()*14) + "px";
    c.style.animationDuration = (1.2 + Math.random()*1.2) + "s";
    c.style.animationDelay = (Math.random()*0.15) + "s";
    fxLayer.appendChild(c);
    setTimeout(()=>c.remove(), 2600);
  }
}

function proJackpotShake(){
  if(!appRoot) return;
  appRoot.classList.remove("jackpot-shake");
  void appRoot.offsetWidth;
  appRoot.classList.add("jackpot-shake");
  setTimeout(()=>appRoot.classList.remove("jackpot-shake"), 900);
}

function wheelJackpotGlow(){
  if(!wheel) return;
  wheel.classList.remove("jackpot-glow");
  void wheel.offsetWidth;
  wheel.classList.add("jackpot-glow");
  setTimeout(()=>wheel.classList.remove("jackpot-glow"), 900);
}

/* PRO MODE: pacchetto completo jackpot */
function showJackpotBottom(){
  const jb = document.getElementById("jackpotBottom");
  if(!jb) return;
  jb.classList.remove("hidden");
  jb.classList.add("show");
  // hide after 3s
  setTimeout(()=>{
    jb.classList.remove("show");
    jb.classList.add("hidden");
  }, 3000);
}

function lockUIForJackpot(ms=5000){
  const btns = [spinBtn, resetBtn];
  btns.forEach(b=>{
    if(!b) return;
    b.classList.add("locked");
    b.disabled = true;
  });
  setTimeout(()=>{
    // resetBtn stays usable (game is locked anyway), but allow it visually
    if(resetBtn){
      resetBtn.classList.remove("locked");
      resetBtn.disabled = false;
    }
  }, ms);
}

function spawnFireworksBottom(bursts=4){
  const layer = document.getElementById("fireworkLayer");
  if(!layer) return;

  const vw = window.innerWidth || 360;
  const vh = window.innerHeight || 640;

  const rocketCount = Math.max(3, bursts * 2);
  for(let r=0;r<rocketCount;r++){
    const rocket = document.createElement("div");
    rocket.className = "fw-rocket";
    const x = Math.floor(vw * (0.15 + Math.random()*0.70));
    rocket.style.left = x + "px";
    rocket.style.setProperty("--yEnd", (-Math.floor(vh*(0.45 + Math.random()*0.30))) + "px");
    layer.appendChild(rocket);

    const onEnd = () => {
      // burst sparks
      const sparks = 18 + ((Math.random()*10)|0);
      for(let i=0;i<sparks;i++){
        const s = document.createElement("div");
        s.className = "fw-spark";
        s.style.left = x + "px";
        s.style.bottom = Math.floor(vh*(0.35 + Math.random()*0.25)) + "px";
        const ang = Math.random()*Math.PI*2;
        const dist = 90 + Math.random()*160;
        s.style.setProperty("--dx", Math.cos(ang)*dist + "px");
        s.style.setProperty("--dy", Math.sin(ang)*dist + "px");
        s.style.animationDuration = (0.9 + Math.random()*0.6) + "s";
        layer.appendChild(s);
        setTimeout(()=>s.remove(), 1400);
      }
      rocket.removeEventListener("animationend", onEnd);
      rocket.remove();
    };

    rocket.addEventListener("animationend", onEnd);
  }
}


let universeUnlocked = false;

function armUniverseMedia(){
  if(universeUnlocked) return;

  const ua = document.getElementById("universeAudio");
  const uv = document.getElementById("universeVideo");

  // Must run inside a real user gesture (e.g. click on Spin)
  if (ua){
    ua.muted = false;
    ua.volume = 1;
    try{
      ua.currentTime = 0;
      ua.play().then(()=>{
        ua.pause();
        ua.currentTime = 0;
        universeUnlocked = true;
      }).catch(()=>{});
    }catch(e){}
  }

  if (uv){
    uv.muted = true; // keep video muted, audio comes from MP3
    try{
      uv.currentTime = 0;
      uv.play().then(()=>{
        uv.pause();
        uv.currentTime = 0;
        universeUnlocked = true;
      }).catch(()=>{});
    }catch(e){}
  }
}

function playUniverseJackpot(durationMs=6500){
  const box = document.getElementById("jackpotUniverse");
  const video = document.getElementById("universeVideo");
  const audio = document.getElementById("universeAudio");

  if(!box || !video || !audio) return;

  // Pause any currently playing SFX to avoid overlaps
  try{
    [spinSound, winSmallSound, winMediumSound, jackpotSound, loseSound].forEach(s=>{
      if(!s) return;
      s.pause();
      s.currentTime = 0;
    });
  }catch(e){}

  // Duck background music while Universe plays
  let hadMusic = false;
  let prevVol = 0.25;
  if (typeof bgMusic !== "undefined" && bgMusic && !bgMusic.paused){
    hadMusic = true;
    prevVol = bgMusic.volume;
    bgMusic.volume = 0.05;
  }

  // Video muted: audio comes from MP3
  video.muted = true;

  try { video.currentTime = 0; } catch(e){}
  try { audio.currentTime = 0; } catch(e){}

  box.classList.remove("hidden");
  box.classList.add("show");

  const p1 = video.play().catch(()=>{});
  const p2 = audio.play().catch(()=>{});

  const stop = () => {
    try{ video.pause(); }catch(e){}
    try{ audio.pause(); }catch(e){}
    box.classList.remove("show");
    box.classList.add("hidden");
    if(hadMusic && typeof bgMusic !== "undefined" && bgMusic) bgMusic.volume = prevVol;
  };

  // stop on audio end OR after duration
  audio.addEventListener("ended", stop, { once:true });
  setTimeout(stop, durationMs);
}


function triggerProJackpotEffects(){
  fxFlash();
  spawnConfettiBurst(85);
  proJackpotShake();
  wheelJackpotGlow();
  showJackpotBottom();
  spawnFireworksBottom(5);
  lockUIForJackpot(5000);
}

/* ELEMENTI GENERALI */
const textRing = document.getElementById('textRing');
const appRoot = document.getElementById('appRoot');

const ledRing = document.getElementById('ledRing');
(function createLedRing() {
  if (!ledRing) return;
  const count = 40;
  for (let i = 0; i < count; i++) {
    const dot = document.createElement('div');
    dot.className = 'led-dot';
    const angle = (360 / count) * i;
    dot.style.transform = 'rotate(' + angle + 'deg) translate(0,-50%)';
    dot.style.animationDelay = (i * 0.05) + 's';
    ledRing.appendChild(dot);
  }
})();

/* AUDIO */
const bgMusic = document.getElementById('bgMusic');
const spinSound = document.getElementById('spinSound');
const winSmallSound = document.getElementById('winSmallSound');
const winMediumSound = document.getElementById('winMediumSound');
const jackpotSound = document.getElementById('jackpotSound');
const loseSound = document.getElementById('loseSound');
const musicToggle = document.getElementById('musicToggle');

let musicOn = false;
let audioUnlocked = false;

if (spinSound) spinSound.volume = 0.8;
if (winSmallSound) winSmallSound.volume = 0.9;
if (winMediumSound) winMediumSound.volume = 0.9;
if (jackpotSound) jackpotSound.volume = 1.0;
if (loseSound) loseSound.volume = 0.9;
if (bgMusic) bgMusic.volume = 0.25;

let bgPrevVolume = 0.25;
let bgDucked = false;

function stopAllEffectSounds() {
  [winSmallSound, winMediumSound, jackpotSound, loseSound].forEach(s => {
    if (!s) return;
    s.pause();
    s.currentTime = 0;
  });
}

function playEffectWithDuck(sound) {
  if (!sound) return;

  stopAllEffectSounds();

  let hadMusic = false;

  if (bgMusic && !bgMusic.paused) {
    hadMusic = true;
    if (!bgDucked) {
      bgPrevVolume = bgMusic.volume;
    }
    bgMusic.volume = 0.05;
    bgDucked = true;
  }

  try {
    sound.currentTime = 0;
    sound.play().catch(() => {});
  } catch (e) {}

  const restore = () => {
    if (hadMusic && bgMusic) {
      bgMusic.volume = bgPrevVolume;
    }
    bgDucked = false;
    sound.removeEventListener("ended", restore);
  };

  sound.addEventListener("ended", restore);
}

async function setMusic(on) {
  try {
    if (on) {
      bgMusic.muted = false;
      await bgMusic.play();
      musicOn = true;
      musicToggle.textContent = "üîä Musica di sottofondo: ON (tocca per OFF)";
    } else {
      bgMusic.pause();
      musicOn = false;
      musicToggle.textContent = "üîä Musica di sottofondo: OFF (tocca per ON)";
    }
  } catch(e) {}
}

document.addEventListener("click", () => {
  if (!audioUnlocked) {
    [bgMusic, spinSound, winSmallSound, winMediumSound, jackpotSound, loseSound]
      .forEach(a => { if (a) a.muted = false; });
    
    // UNLOCK Universe audio/video (mobile safe)
    const ua = document.getElementById("universeAudio");
    const uv = document.getElementById("universeVideo");

    if (ua) {
      ua.muted = false;
      ua.volume = 1;
      ua.play().then(() => {
        ua.pause();
        ua.currentTime = 0;
      }).catch(() => {});
    }

    if (uv) {
      uv.muted = true; // keep video muted, audio from MP3
      uv.play().then(() => {
        uv.pause();
        uv.currentTime = 0;
      }).catch(() => {});
    }

    audioUnlocked = true;
  }
}, { once: true });

musicToggle.addEventListener("click", () => setMusic(!musicOn));

/* LOGIN PRESENTATORE */
const loginScreen = document.getElementById("loginScreen");
const loginForm = document.getElementById("loginForm");
const loginUser = document.getElementById("loginUser");
const loginPass = document.getElementById("loginPass");

const ADMIN_USER = "presenter";
const ADMIN_PASS = "smartphonemania";

function checkAlreadyLogged() {
  const flag = localStorage.getItem("sm_wheel_logged_in");
  if (flag === "1") {
    if (loginScreen) loginScreen.style.display = "none";
    if (appRoot) appRoot.style.display = "block";
  }
}

if (loginForm) {
  loginForm.addEventListener("submit", function (e) {
    e.preventDefault();
    const u = (loginUser.value || "").trim();
    const p = loginPass.value || "";

    if (u === ADMIN_USER && p === ADMIN_PASS) {
      localStorage.setItem("sm_wheel_logged_in", "1");
      if (loginScreen) loginScreen.style.display = "none";
      if (appRoot) appRoot.style.display = "block";
    } else {
      alert("Credenziali errate. Riprova.");
    }
  });
}

/* ECONOMIA E LOGICA RUOTA */
const TICKET_PRICE = 100;
const TIKTOK_FEE_RATE = 0.55;
const NET_PER_SPIN = TICKET_PRICE * (1 - TIKTOK_FEE_RATE);
const JACKPOT_THRESHOLD_PROFIT = 40000;
const JACKPOT_BASE_PROB = 0.5;

const wheel = document.getElementById("wheel");
const spinBtn = document.getElementById("spinBtn");
const resetBtn = document.getElementById("resetBtn");
const resultBox = document.getElementById("resultBox");
const prizeOverlay = document.getElementById("prize-overlay");
const statSpins = document.getElementById("statSpins");
const statPrizes = document.getElementById("statPrizes");

const multiSpinsInput = document.getElementById("multiSpinsInput");
const multiStatus = document.getElementById("multiStatus");
const spinCostSelector = document.getElementById("spinCostSelector");

/* Nick & Classifica */
const nickInput = document.getElementById("nickInput");
const saveNickBtn = document.getElementById("saveNickBtn");
const currentNickLabel = document.getElementById("currentNick");
const leaderboardTop3El = document.getElementById("leaderboardTop3");
const leaderboardAllEl = document.getElementById("leaderboardAll");
const leaderboardAllWrap = document.getElementById("leaderboardAllWrap");
const lbToggleBtn = document.getElementById("lbToggleBtn");
const donorSelect = document.getElementById("donorSelect");

let isSpinning = false;
let currentRotation = 0;

let totalSpins = 0;
let totalNet = 0;
let totalPrizeCost = 0;
let jackpotCount = 0;

let currentNick = "";
const LEADERBOARD_KEY = "sm_wheel_leaderboard";

let multiSpinsRemaining = 0;
let multiSpinsTotal = 0;

let gameLocked = false;

if (lbToggleBtn && leaderboardAllWrap){
  lbToggleBtn.addEventListener("click", ()=>{
    leaderboardAllWrap.classList.toggle("hidden");
    lbToggleBtn.textContent = leaderboardAllWrap.classList.contains("hidden")
      ? "üìú Vedi tutti i donatori"
      : "‚ùå Chiudi elenco donatori";
  });
}



if (donorSelect){
  donorSelect.addEventListener("change", ()=>{
    const v = (donorSelect.value || "").trim();
    if(!v) return;
    // set nick quickly
    currentNick = v;
    if (nickInput) nickInput.value = v;
    refreshNickLabel();
    localStorage.setItem("sm_wheel_nick", currentNick);
  });
}
function formatNumber(n){ return n.toLocaleString("it-IT"); }
function escapeHtml(str){
  return String(str || "").replace(/[&<>"']/g, (c)=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c]));
}


function saveStats(){
  const data = { totalSpins, totalNet, totalPrizeCost, jackpotCount };
  localStorage.setItem("sm_wheel_stats_simple", JSON.stringify(data));
}
function loadStats(){
  try{
    const raw = localStorage.getItem("sm_wheel_stats_simple");
    if(!raw) return;
    const d = JSON.parse(raw);
    totalSpins = d.totalSpins || 0;
    totalNet = d.totalNet || 0;
    totalPrizeCost = d.totalPrizeCost || 0;
    jackpotCount = d.jackpotCount || 0;
  }catch(e){}
}
function updateStatsBox(){
  statSpins.textContent = totalSpins;
  statPrizes.textContent = formatNumber(Math.round(totalPrizeCost));
  saveStats();
}

/* Nick */
function refreshNickLabel() {
  if (currentNick && currentNick.trim() !== "") {
    currentNickLabel.textContent = "Nick attivo: " + currentNick;
  } else {
    currentNickLabel.textContent = "Nessun Nick selezionato.";
  }
}
function loadNick() {
  const stored = localStorage.getItem("sm_wheel_nick") || "";
  currentNick = stored;
  if (nickInput) nickInput.value = stored;
  refreshNickLabel();
}
function saveNick() {
  const value = nickInput.value.trim();
  if (!value) {
    alert("Inserisci un Nick valido.");
    return;
  }
  currentNick = value;
  localStorage.setItem("sm_wheel_nick", currentNick);
  refreshNickLabel();
}
if (saveNickBtn) {
  saveNickBtn.addEventListener("click", saveNick);
}

/* Classifica */
function loadLeaderboard() {
  try {
    const raw = localStorage.getItem(LEADERBOARD_KEY);
    if (!raw) return [];
    const arr = JSON.parse(raw);
    if (!Array.isArray(arr)) return [];
    return arr;
  } catch(e) {
    return [];
  }
}
function saveLeaderboard(lb) {
  localStorage.setItem(LEADERBOARD_KEY, JSON.stringify(lb));
}
function renderLeaderboard() {
  const lb = loadLeaderboard();
  lb.sort((a,b) => b.totalPrize - a.totalPrize);

  // TOP 3
  if (leaderboardTop3El){
    if (lb.length === 0) {
      leaderboardTop3El.innerHTML = "<li>Nessun benefattore registrato per ora.</li>";
    } else {
      const top3 = lb.slice(0, 3);
      leaderboardTop3El.innerHTML = top3.map((e, idx) => `
        <li>
          <strong>#${idx+1} ${e.nick}</strong> ‚Äî ${formatNumber(e.totalPrize)} monete
          (giri premiati: ${e.spins}${e.jackpots > 0 ? `, jackpot: ${e.jackpots}` : ""})
        </li>
      `).join("");
    }
  }

  // FULL LIST (scroll)
  if (leaderboardAllEl){
    if (lb.length === 0){
      leaderboardAllEl.innerHTML = "<li>Nessun benefattore registrato per ora.</li>";
    } else {
      leaderboardAllEl.innerHTML = lb.map((e, idx) => `
        <li>
          <strong>#${idx+1} ${e.nick}</strong> ‚Äî ${formatNumber(e.totalPrize)} monete
          (giri premiati: ${e.spins}${e.jackpots > 0 ? `, jackpot: ${e.jackpots}` : ""})
        </li>
      `).join("");
    }
  }

  // SELECT (choose donor)
  if (donorSelect){
    const current = donorSelect.value || "";
    const options = ['<option value="">Seleziona un donatore‚Ä¶</option>']
      .concat(lb.map(e => `<option value="${escapeHtml(e.nick)}">${escapeHtml(e.nick)} ‚Äî ${formatNumber(e.totalPrize)} monete</option>`));
    donorSelect.innerHTML = options.join("");
    if (current) donorSelect.value = current;
  }
}
function updateLeaderboard(nick, prizeAmount, isJackpot) {
  if (!nick || !nick.trim()) return;
  if (prizeAmount <= 0) {
    renderLeaderboard();
    return;
  }
  const lb = loadLeaderboard();
  let entry = lb.find(e => e.nick === nick);
  if (!entry) {
    entry = { nick, totalPrize: 0, spins: 0, jackpots: 0 };
    lb.push(entry);
  }
  entry.totalPrize += prizeAmount;
  entry.spins += 1;
  if (isJackpot) entry.jackpots += 1;
  saveLeaderboard(lb);
  renderLeaderboard();
}

/* Popup "Giro X di Y" */
function updateMultiStatusDisplay(currentNumber) {
  if (!multiStatus) return;
  if (multiSpinsTotal > 1 && multiSpinsRemaining > 0) {
    if (currentNumber > 0) {
      multiStatus.textContent = `Giro ${currentNumber} di ${multiSpinsTotal}`;
    }
    multiStatus.classList.remove("hidden");
  } else {
    multiStatus.classList.add("hidden");
  }
}

/* Monete per giro -> quanti giri BASE da 100 */
function getBaseSpinsPerClick() {
  const val = parseInt(spinCostSelector.value, 10);
  if (isNaN(val) || val < TICKET_PRICE) return 1;
  return Math.max(1, val / TICKET_PRICE);
}

/* Helper random e premi */
function randomInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }

const prizeDefs = {
  JACKPOT: { name: "JACKPOT",      label: "üí• JACKPOT 45.000 monete", amount: 45000 },
  P2500:   { name: "PREMIO_TOP",   label: "üéÅ Premio top 2.500 monete", amount: 2500 },
  P1000:   { name: "PREMIO_ALTO",  label: "üéÅ Premio alto 1.000 monete", amount: 1000 },
  P500:    { name: "PREMIO_MEDIO", label: "üéÅ Premio medio 500 monete",   amount: 500 },
  P250:    { name: "PREMIO_BASSO", label: "üéÅ Premio basso 250 monete",   amount: 250 },
  P100:    { name: "PREMIO_MINI",  label: "üéÅ Premio mini 100 monete",    amount: 100 },
  NO_WIN:  { name: "NESSUN_PREMIO",label: "‚ùå Nessun premio",             amount: 0 }
};

const segmentRanges = [
  { segmentIndex: 2, prizeKey: "P100",  rangeStart:   2, rangeEnd: 201 },
  { segmentIndex: 5, prizeKey: "P250",  rangeStart: 202, rangeEnd: 211 },
  { segmentIndex: 3, prizeKey: "P500",  rangeStart: 212, rangeEnd: 215 },
  { segmentIndex: 1, prizeKey: "P1000", rangeStart: 216, rangeEnd: 216 },
  { segmentIndex: 6, prizeKey: "P2500", rangeStart: 217, rangeEnd: 217 },
  { segmentIndex: 0, prizeKey: "NO_WIN", rangeStart:   1, rangeEnd:   1 },
  { segmentIndex: 4, prizeKey: "NO_WIN", rangeStart: 218, rangeEnd: 1000 }
];

/* Un singolo giro BASE (da 100 monete) */
function pickPrizeByRandom() {
  const rnd = randomInt(1,1000);
  const tentativeTotalNet = totalNet + NET_PER_SPIN;

  if (!gameLocked && rnd === 1) {
    const jackpotAmount = prizeDefs.JACKPOT.amount;
    const profitIfJackpot = tentativeTotalNet - (totalPrizeCost + jackpotAmount);

    if (profitIfJackpot >= JACKPOT_THRESHOLD_PROFIT) {
      const roll = Math.random();
      if (roll <= JACKPOT_BASE_PROB) {
        totalSpins += 1;
        totalNet = tentativeTotalNet;
        totalPrizeCost += jackpotAmount;
        jackpotCount += 1;
        updateStatsBox();

        return {
          rnd,
          def: prizeDefs.JACKPOT,
          prizeCost: jackpotAmount,
          segmentIndex: 7,
          isJackpot: true
        };
      }
    }
  }

  const segInfo = segmentRanges.find(r => rnd >= r.rangeStart && r.rangeEnd >= rnd);
  const def = prizeDefs[segInfo.prizeKey];
  const prizeCost = def.amount;

  totalSpins += 1;
  totalNet = tentativeTotalNet;
  totalPrizeCost += prizeCost;
  updateStatsBox();

  return {
    rnd,
    def,
    prizeCost,
    segmentIndex: segInfo.segmentIndex,
    isJackpot: false
  };
}

/* Un lancio ‚Äúgrosso‚Äù = N giri BASE da 100 */
function runAggregatedSpin() {
  const baseSpins = getBaseSpinsPerClick();
  let aggregatedPrize = 0;
  let lastInfo = null;
  let jackpotInThis = false;

  for (let i = 0; i < baseSpins; i++) {
    const info = pickPrizeByRandom();
    aggregatedPrize += info.prizeCost;
    lastInfo = info;
    if (info.def.name === "JACKPOT") {
      jackpotInThis = true;
      break;
    }
  }

  let labelDef;
  if (jackpotInThis) {
    labelDef = prizeDefs.JACKPOT;
  } else if (aggregatedPrize === 0) {
    labelDef = prizeDefs.NO_WIN;
  } else {
    labelDef = {
      name: "PREMIO_CUMULATO",
      label: "üéÅ Premio complessivo",
      amount: aggregatedPrize
    };
  }

  const segmentIndex = jackpotInThis ? 7 : (lastInfo ? lastInfo.segmentIndex : 0);

  return {
    labelDef,
    aggregatedPrize,
    spinsBase: baseSpins,
    lastRnd: lastInfo ? lastInfo.rnd : "-",
    isJackpot: jackpotInThis,
    segmentIndex
  };
}

function showPrizeBanner(def, prizeAmount) {
  const isJackpot = def.name === "JACKPOT";
  const amountText = prizeAmount > 0
    ? `${formatNumber(prizeAmount)} MONETE`
    : "NESSUN PREMIO";

  const title = isJackpot
    ? "JACKPOT!"
    : (prizeAmount > 0 ? "HAI VINTO!" : "RITENTA");

  const sub = isJackpot
    ? "SUPER JACKPOT! GIOCO BLOCCATO. Premi \"Azzera sessione\" per ripartire. üéâ"
    : (prizeAmount > 0 ? "Premio complessivo assegnato alla ruota di SmartphoneMania." : "Nessun premio in questo giro.");

  const fixedClass = isJackpot ? "prize-overlay-fixed" : "";
  prizeOverlay.classList.remove("hidden");
  prizeOverlay.innerHTML = `
    <div class="prize-overlay ${fixedClass}">
      <div class="prize-banner ${isJackpot ? "jackpot" : ""}">
        <div class="prize-title ${isJackpot ? "jackpot" : ""}">${title}</div>
        <div class="prize-amount ${isJackpot ? "jackpot" : ""}">${amountText}</div>
        <div class="prize-sub">${sub}</div>
      </div>
    </div>
  `;

  if (!isJackpot) {
    setTimeout(() => {
      prizeOverlay.classList.add("hidden");
      prizeOverlay.innerHTML = "";
    }, 2200);
  }
}

/* UI per risultato aggregato */
function updateResultUI(aggInfo) {
  const { labelDef, aggregatedPrize, spinsBase, lastRnd, isJackpot } = aggInfo;

  const cls =
    labelDef.name === "JACKPOT" ? "jackpot" :
    aggregatedPrize === 0 ? "lose" : "win";

  const numeroEstratto = isJackpot ? "‚òÖ JACKPOT ‚òÖ" : lastRnd;

  resultBox.innerHTML = `
    <div class="result-title"><span>${labelDef.name==="JACKPOT"?"üåü":"üéÅ"}</span>Ultimo risultato</div>
    <p class="result-main ${cls}">${labelDef.label}</p>
    <p class="result-sub">Giri BASE (da 100) in questo lancio: <span>${spinsBase}</span></p>
    <p class="result-sub">Numero estratto (ultimo): <span>${numeroEstratto}</span></p>
    <p class="result-sub">Premio complessivo: <span>${formatNumber(aggregatedPrize)}</span> monete</p>
    <p class="result-sub">Giri BASE totali finora: <span>${totalSpins}</span></p>
    <p class="result-sub">Premi totali erogati: <span>${formatNumber(totalPrizeCost)}</span> monete</p>
  `;

  if (labelDef.name === "JACKPOT") {
    // PRO MODE FX + suono jackpot
    triggerProJackpotEffects();
    playUniverseJackpot(6500);
    // OPTIONAL: keep classic jackpot sound too
    playEffectWithDuck(jackpotSound);
  } else if (aggregatedPrize > 0) {
    if (aggregatedPrize <= 250) {
      playEffectWithDuck(winSmallSound);
    } else {
      playEffectWithDuck(winMediumSound);
    }
  } else {
    playEffectWithDuck(loseSound);
  }

  showPrizeBanner(labelDef, aggregatedPrize);
}

function normalizeAngle(a){ a = a%360; if(a<0)a+=360; return a; }

function spinAnimation(segmentIndex, cb){
  if(isSpinning) return;
  isSpinning = true;
  spinBtn.disabled = true;

  const segmentAngle = 45;
  const targetCenterAngle = normalizeAngle(-90 + segmentIndex*segmentAngle + segmentAngle/2);
  const current = normalizeAngle(currentRotation);
  let delta = targetCenterAngle - current;
  delta = normalizeAngle(delta);

  const baseSpins = 6;
  const extra = baseSpins*360 + delta;
  const targetRotation = currentRotation + extra;

  wheel.style.transform = `rotate(${targetRotation}deg)`;
  if (textRing) {
    textRing.style.transform = `rotate(${targetRotation}deg)`;
  }
  currentRotation = targetRotation;

  if (spinSound){
    spinSound.loop = true;
    spinSound.currentTime = 0;
    spinSound.play().catch(()=>{});
  }
  if (!musicOn) setMusic(true);

  setTimeout(() => {
    if (spinSound){
      spinSound.pause();
      spinSound.currentTime = 0;
      spinSound.loop = false;
    }
    isSpinning = false;
    if (!gameLocked) {
      spinBtn.disabled = false;
    }
    cb();
  }, 4800);
}

/* CLICK GIRA LA RUOTA */
spinBtn.addEventListener("click", () => {
  armUniverseMedia();
  if (gameLocked) {
    alert('√à uscito il JACKPOT! Il gioco √® bloccato.\nPremi "Azzera sessione" per ripartire.');
    return;
  }

  if (multiSpinsRemaining > 0 || isSpinning) {
    return;
  }

  if (!currentNick || !currentNick.trim()) {
    alert('Inserisci il tuo Nick e premi "Salva Nick" prima di girare la ruota.');
    return;
  }

  let spinsToDo = 1;
  if (multiSpinsInput) {
    const v = parseInt(multiSpinsInput.value, 10);
    if (!isNaN(v) && v > 0) {
      spinsToDo = Math.min(v, 100);
    }
  }

  multiSpinsTotal = spinsToDo;
  multiSpinsRemaining = spinsToDo;

  function doSpin() {
    if (multiSpinsRemaining <= 0 || gameLocked) {
      multiSpinsRemaining = 0;
      updateMultiStatusDisplay(0);
      return;
    }

    const currentSpinNumber = multiSpinsTotal - multiSpinsRemaining + 1;
    updateMultiStatusDisplay(currentSpinNumber);

    const aggInfo = runAggregatedSpin();

    spinAnimation(aggInfo.segmentIndex, () => {
      updateResultUI(aggInfo);
      updateLeaderboard(currentNick, aggInfo.aggregatedPrize, aggInfo.labelDef.name === "JACKPOT");

      if (aggInfo.labelDef.name === "JACKPOT") {
        gameLocked = true;
        multiSpinsRemaining = 0;
        updateMultiStatusDisplay(0);
        spinBtn.disabled = true;
        if (appRoot) appRoot.classList.add("jackpot-locked");
        return;
      }

      multiSpinsRemaining--;

      if (multiSpinsRemaining > 0) {
        doSpin();
      } else {
        updateMultiStatusDisplay(0);
      }
    });
  }

  doSpin();
});

/* RESET TOTALE */
resetBtn.addEventListener("click", () => {
  const sure = confirm(
    "Vuoi davvero azzerare TUTTI i dati?\n- Statistiche sessione\n- Classifica generale vincitori\n- Sblocco dopo Jackpot"
  );
  if (!sure) return;

  totalSpins = 0;
  totalNet = 0;
  totalPrizeCost = 0;
  jackpotCount = 0;
  multiSpinsRemaining = 0;
  multiSpinsTotal = 0;
  gameLocked = false;
  if (appRoot) appRoot.classList.remove("jackpot-locked");
  spinBtn.disabled = false;
  updateMultiStatusDisplay(0);

  localStorage.removeItem("sm_wheel_stats_simple");
  updateStatsBox();

  localStorage.removeItem(LEADERBOARD_KEY);
  renderLeaderboard();

  prizeOverlay.classList.add("hidden");
  prizeOverlay.innerHTML = "";

  // pulisci FX layer
  if (fxLayer) fxLayer.innerHTML = "";

  resultBox.innerHTML = `
    <div class="result-title"><span>üéÅ</span>Ultimo risultato</div>
    <p>Nessun giro ancora effettuato. Premi "Gira la ruota" per iniziare.</p>`;
});

/* INIT */
loadStats();
updateStatsBox();
if (totalSpins > 0) {
  resultBox.innerHTML = `
    <div class="result-title"><span>üéÅ</span>Ultimo risultato</div>
    <p class="result-sub">Sessione ripresa.</p>
    <p class="result-sub">Giri BASE totali: <span>${totalSpins}</span>.</p>
    <p class="result-sub">Premi totali erogati: <span>${formatNumber(totalPrizeCost)}</span> monete.</p>`;
}

loadNick();
renderLeaderboard();
checkAlreadyLogged();
</script>

</body>
</html>
